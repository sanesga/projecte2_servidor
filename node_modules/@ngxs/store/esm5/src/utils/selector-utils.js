/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { memoize } from '@ngxs/store/internals';
import { ensureSelectorMetadata, getSelectorMetadata, getStoreMetadata, globalSelectorOptions } from '../internal/internals';
/** @type {?} */
var SELECTOR_OPTIONS_META_KEY = 'NGXS_SELECTOR_OPTIONS_META';
/** @type {?} */
export var selectorOptionsMetaAccessor = {
    getOptions: (/**
     * @param {?} target
     * @return {?}
     */
    function (target) {
        return (target && ((/** @type {?} */ (target)))[SELECTOR_OPTIONS_META_KEY]) || {};
    }),
    defineOptions: (/**
     * @param {?} target
     * @param {?} options
     * @return {?}
     */
    function (target, options) {
        if (!target)
            return;
        ((/** @type {?} */ (target)))[SELECTOR_OPTIONS_META_KEY] = options;
    })
};
/**
 * @record
 */
function CreationMetadata() { }
if (false) {
    /** @type {?} */
    CreationMetadata.prototype.containerClass;
    /** @type {?} */
    CreationMetadata.prototype.selectorName;
    /** @type {?|undefined} */
    CreationMetadata.prototype.getSelectorOptions;
}
/**
 * @record
 */
function RuntimeSelectorInfo() { }
if (false) {
    /** @type {?} */
    RuntimeSelectorInfo.prototype.selectorOptions;
    /** @type {?} */
    RuntimeSelectorInfo.prototype.argumentSelectorFunctions;
}
/**
 * Function for creating a selector
 * @template T
 * @param {?} selectors The selectors to use to create the arguments of this function
 * @param {?} originalFn The original function being made into a selector
 * @param {?=} creationMetadata
 * @return {?}
 */
export function createSelector(selectors, originalFn, creationMetadata) {
    /** @type {?} */
    var containerClass = creationMetadata && creationMetadata.containerClass;
    /** @type {?} */
    var wrappedFn = (/** @type {?} */ ((/**
     * @param {...?} args
     * @return {?}
     */
    function wrappedSelectorFn() {
        var args = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            args[_i] = arguments[_i];
        }
        /** @type {?} */
        var returnValue = originalFn.apply(containerClass, args);
        if (returnValue instanceof Function) {
            /** @type {?} */
            var innerMemoizedFn = memoize.apply(null, [returnValue]);
            return innerMemoizedFn;
        }
        return returnValue;
    })));
    /** @type {?} */
    var memoizedFn = memoize(wrappedFn);
    /** @type {?} */
    var selectorMetaData = setupSelectorMetadata(memoizedFn, originalFn, creationMetadata);
    /** @type {?} */
    var runtimeInfo;
    /** @type {?} */
    var selectFromAppState = (/**
     * @param {?} state
     * @return {?}
     */
    function (state) {
        /** @type {?} */
        var results = [];
        runtimeInfo = runtimeInfo || getRuntimeSelectorInfo(selectorMetaData, selectors);
        var suppressErrors = runtimeInfo.selectorOptions.suppressErrors;
        var argumentSelectorFunctions = runtimeInfo.argumentSelectorFunctions;
        // Determine arguments from the app state using the selectors
        results.push.apply(results, tslib_1.__spread(argumentSelectorFunctions.map((/**
         * @param {?} argFn
         * @return {?}
         */
        function (argFn) { return argFn(state); }))));
        // if the lambda tries to access a something on the
        // state that doesn't exist, it will throw a TypeError.
        // since this is quite usual behaviour, we simply return undefined if so.
        try {
            return memoizedFn.apply(void 0, tslib_1.__spread(results));
        }
        catch (ex) {
            if (ex instanceof TypeError && suppressErrors) {
                return undefined;
            }
            throw ex;
        }
    });
    selectorMetaData.selectFromAppState = selectFromAppState;
    return memoizedFn;
}
/**
 * @template T
 * @param {?} memoizedFn
 * @param {?} originalFn
 * @param {?} creationMetadata
 * @return {?}
 */
function setupSelectorMetadata(memoizedFn, originalFn, creationMetadata) {
    /** @type {?} */
    var selectorMetaData = ensureSelectorMetadata(memoizedFn);
    selectorMetaData.originalFn = originalFn;
    /** @type {?} */
    var getExplicitSelectorOptions = (/**
     * @return {?}
     */
    function () { return ({}); });
    if (creationMetadata) {
        selectorMetaData.containerClass = creationMetadata.containerClass;
        selectorMetaData.selectorName = creationMetadata.selectorName;
        getExplicitSelectorOptions =
            creationMetadata.getSelectorOptions || getExplicitSelectorOptions;
    }
    /** @type {?} */
    var selectorMetaDataClone = tslib_1.__assign({}, selectorMetaData);
    selectorMetaData.getSelectorOptions = (/**
     * @return {?}
     */
    function () {
        return getCustomSelectorOptions(selectorMetaDataClone, getExplicitSelectorOptions());
    });
    return selectorMetaData;
}
/**
 * @param {?} selectorMetaData
 * @param {?=} selectors
 * @return {?}
 */
function getRuntimeSelectorInfo(selectorMetaData, selectors) {
    if (selectors === void 0) { selectors = []; }
    /** @type {?} */
    var selectorOptions = selectorMetaData.getSelectorOptions();
    /** @type {?} */
    var selectorsToApply = getSelectorsToApply(selectorMetaData, selectors);
    /** @type {?} */
    var argumentSelectorFunctions = selectorsToApply.map((/**
     * @param {?} selector
     * @return {?}
     */
    function (selector) { return getSelectorFn(selector); }));
    return {
        selectorOptions: selectorOptions,
        argumentSelectorFunctions: argumentSelectorFunctions
    };
}
/**
 * @param {?} selectorMetaData
 * @param {?} explicitOptions
 * @return {?}
 */
function getCustomSelectorOptions(selectorMetaData, explicitOptions) {
    /** @type {?} */
    var selectorOptions = tslib_1.__assign({}, globalSelectorOptions.get(), (selectorOptionsMetaAccessor.getOptions(selectorMetaData.containerClass) || {}), (selectorOptionsMetaAccessor.getOptions(selectorMetaData.originalFn) || {}), (selectorMetaData.getSelectorOptions() || {}), explicitOptions);
    return selectorOptions;
}
/**
 * @param {?} selectorMetaData
 * @param {?=} selectors
 * @return {?}
 */
function getSelectorsToApply(selectorMetaData, selectors) {
    if (selectors === void 0) { selectors = []; }
    /** @type {?} */
    var selectorsToApply = [];
    /** @type {?} */
    var canInjectContainerState = selectors.length === 0 || selectorMetaData.getSelectorOptions().injectContainerState;
    /** @type {?} */
    var containerClass = selectorMetaData.containerClass;
    if (containerClass && canInjectContainerState) {
        // If we are on a state class, add it as the first selector parameter
        /** @type {?} */
        var metadata = getStoreMetadata(containerClass);
        if (metadata) {
            selectorsToApply.push(containerClass);
        }
    }
    if (selectors) {
        selectorsToApply.push.apply(selectorsToApply, tslib_1.__spread(selectors));
    }
    return selectorsToApply;
}
/**
 * This function gets the selector function to be used to get the selected slice from the app state
 * @ignore
 * @param {?} selector
 * @return {?}
 */
export function getSelectorFn(selector) {
    /** @type {?} */
    var metadata = getSelectorMetadata(selector) || getStoreMetadata(selector);
    return (metadata && metadata.selectFromAppState) || selector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0b3ItdXRpbHMuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Abmd4cy9zdG9yZS8iLCJzb3VyY2VzIjpbInNyYy91dGlscy9zZWxlY3Rvci11dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUVoRCxPQUFPLEVBQ0wsc0JBQXNCLEVBQ3RCLG1CQUFtQixFQUNuQixnQkFBZ0IsRUFDaEIscUJBQXFCLEVBSXRCLE1BQU0sdUJBQXVCLENBQUM7O0lBRXpCLHlCQUF5QixHQUFHLDRCQUE0Qjs7QUFFOUQsTUFBTSxLQUFPLDJCQUEyQixHQUFHO0lBQ3pDLFVBQVU7Ozs7SUFBRSxVQUFDLE1BQVc7UUFDdEIsT0FBTyxDQUFDLE1BQU0sSUFBSSxDQUFDLG1CQUFLLE1BQU0sRUFBQSxDQUFDLENBQUMseUJBQXlCLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNwRSxDQUFDLENBQUE7SUFDRCxhQUFhOzs7OztJQUFFLFVBQUMsTUFBVyxFQUFFLE9BQThCO1FBQ3pELElBQUksQ0FBQyxNQUFNO1lBQUUsT0FBTztRQUNwQixDQUFDLG1CQUFLLE1BQU0sRUFBQSxDQUFDLENBQUMseUJBQXlCLENBQUMsR0FBRyxPQUFPLENBQUM7SUFDckQsQ0FBQyxDQUFBO0NBQ0Y7Ozs7QUFFRCwrQkFJQzs7O0lBSEMsMENBQW9COztJQUNwQix3Q0FBcUI7O0lBQ3JCLDhDQUFpRDs7Ozs7QUFHbkQsa0NBR0M7OztJQUZDLDhDQUF1Qzs7SUFDdkMsd0RBQW1EOzs7Ozs7Ozs7O0FBU3JELE1BQU0sVUFBVSxjQUFjLENBQzVCLFNBQTRCLEVBQzVCLFVBQWEsRUFDYixnQkFBbUM7O1FBRTdCLGNBQWMsR0FBRyxnQkFBZ0IsSUFBSSxnQkFBZ0IsQ0FBQyxjQUFjOztRQUNwRSxTQUFTLEdBQUc7Ozs7SUFBQSxTQUFTLGlCQUFpQjtRQUFDLGNBQWM7YUFBZCxVQUFjLEVBQWQscUJBQWMsRUFBZCxJ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Q0FBQztJQUM1RSxPQUFPLENBQUMsUUFBUSxJQUFJLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLFFBQVEsQ0FBQztBQUMvRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgbWVtb2l6ZSB9IGZyb20gJ0BuZ3hzL3N0b3JlL2ludGVybmFscyc7XHJcblxyXG5pbXBvcnQge1xyXG4gIGVuc3VyZVNlbGVjdG9yTWV0YWRhdGEsXHJcbiAgZ2V0U2VsZWN0b3JNZXRhZGF0YSxcclxuICBnZXRTdG9yZU1ldGFkYXRhLFxyXG4gIGdsb2JhbFNlbGVjdG9yT3B0aW9ucyxcclxuICBTZWxlY3RGcm9tU3RhdGUsXHJcbiAgU2VsZWN0b3JNZXRhRGF0YU1vZGVsLFxyXG4gIFNoYXJlZFNlbGVjdG9yT3B0aW9uc1xyXG59IGZyb20gJy4uL2ludGVybmFsL2ludGVybmFscyc7XHJcblxyXG5jb25zdCBTRUxFQ1RPUl9PUFRJT05TX01FVEFfS0VZID0gJ05HWFNfU0VMRUNUT1JfT1BUSU9OU19NRVRBJztcclxuXHJcbmV4cG9ydCBjb25zdCBzZWxlY3Rvck9wdGlvbnNNZXRhQWNjZXNzb3IgPSB7XHJcbiAgZ2V0T3B0aW9uczogKHRhcmdldDogYW55KTogU2hhcmVkU2VsZWN0b3JPcHRpb25zID0+IHtcclxuICAgIHJldHVybiAodGFyZ2V0ICYmICg8YW55PnRhcmdldClbU0VMRUNUT1JfT1BUSU9OU19NRVRBX0tFWV0pIHx8IHt9O1xyXG4gIH0sXHJcbiAgZGVmaW5lT3B0aW9uczogKHRhcmdldDogYW55LCBvcHRpb25zOiBTaGFyZWRTZWxlY3Rvck9wdGlvbnMpID0+IHtcclxuICAgIGlmICghdGFyZ2V0KSByZXR1cm47XHJcbiAgICAoPGFueT50YXJnZXQpW1NFTEVDVE9SX09QVElPTlNfTUVUQV9LRVldID0gb3B0aW9ucztcclxuICB9XHJcbn07XHJcblxyXG5pbnRlcmZhY2UgQ3JlYXRpb25NZXRhZGF0YSB7XHJcbiAgY29udGFpbmVyQ2xhc3M6IGFueTtcclxuICBzZWxlY3Rvck5hbWU6IHN0cmluZztcclxuICBnZXRTZWxlY3Rvck9wdGlvbnM/OiAoKSA9PiBTaGFyZWRTZWxlY3Rvck9wdGlvbnM7XHJcbn1cclxuXHJcbmludGVyZmFjZSBSdW50aW1lU2VsZWN0b3JJbmZvIHtcclxuICBzZWxlY3Rvck9wdGlvbnM6IFNoYXJlZFNlbGVjdG9yT3B0aW9ucztcclxuICBhcmd1bWVudFNlbGVjdG9yRnVuY3Rpb25zOiAoKHN0YXRlOiBhbnkpID0+IGFueSlbXTtcclxufVxyXG5cclxuLyoqXHJcbiAqIEZ1bmN0aW9uIGZvciBjcmVhdGluZyBhIHNlbGVjdG9yXHJcbiAqIEBwYXJhbSBzZWxlY3RvcnMgVGhlIHNlbGVjdG9ycyB0byB1c2UgdG8gY3JlYXRlIHRoZSBhcmd1bWVudHMgb2YgdGhpcyBmdW5jdGlvblxyXG4gKiBAcGFyYW0gb3JpZ2luYWxGbiBUaGUgb3JpZ2luYWwgZnVuY3Rpb24gYmVpbmcgbWFkZSBpbnRvIGEgc2VsZWN0b3JcclxuICogQHBhcmFtIGNyZWF0aW9uTWV0YWRhdGFcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVTZWxlY3RvcjxUIGV4dGVuZHMgKC4uLmFyZ3M6IGFueVtdKSA9PiBhbnk+KFxyXG4gIHNlbGVjdG9yczogYW55W10gfCB1bmRlZmluZWQsXHJcbiAgb3JpZ2luYWxGbjogVCxcclxuICBjcmVhdGlvbk1ldGFkYXRhPzogQ3JlYXRpb25NZXRhZGF0YVxyXG4pIHtcclxuICBjb25zdCBjb250YWluZXJDbGFzcyA9IGNyZWF0aW9uTWV0YWRhdGEgJiYgY3JlYXRpb25NZXRhZGF0YS5jb250YWluZXJDbGFzcztcclxuICBjb25zdCB3cmFwcGVkRm4gPSBmdW5jdGlvbiB3cmFwcGVkU2VsZWN0b3JGbiguLi5hcmdzOiBhbnlbXSkge1xyXG4gICAgY29uc3QgcmV0dXJuVmFsdWUgPSBvcmlnaW5hbEZuLmFwcGx5KGNvbnRhaW5lckNsYXNzLCBhcmdzKTtcclxuICAgIGlmIChyZXR1cm5WYWx1ZSBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7XHJcbiAgICAgIGNvbnN0IGlubmVyTWVtb2l6ZWRGbiA9IG1lbW9pemUuYXBwbHkobnVsbCwgW3JldHVyblZhbHVlXSk7XHJcbiAgICAgIHJldHVybiBpbm5lck1lbW9pemVkRm47XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmV0dXJuVmFsdWU7XHJcbiAgfSBhcyBUO1xyXG4gIGNvbnN0IG1lbW9pemVkRm4gPSBtZW1vaXplKHdyYXBwZWRGbik7XHJcbiAgY29uc3Qgc2VsZWN0b3JNZXRhRGF0YSA9IHNldHVwU2VsZWN0b3JNZXRhZGF0YTxUPihtZW1vaXplZEZuLCBvcmlnaW5hbEZuLCBjcmVhdGlvbk1ldGFkYXRhKTtcclxuICBsZXQgcnVudGltZUluZm86IFJ1bnRpbWVTZWxlY3RvckluZm87XHJcblxyXG4gIGNvbnN0IHNlbGVjdEZyb21BcHBTdGF0ZSA9IChzdGF0ZTogYW55KSA9PiB7XHJcbiAgICBjb25zdCByZXN1bHRzID0gW107XHJcblxyXG4gICAgcnVudGltZUluZm8gPSBydW50aW1lSW5mbyB8fCBnZXRSdW50aW1lU2VsZWN0b3JJbmZvKHNlbGVjdG9yTWV0YURhdGEsIHNlbGVjdG9ycyk7XHJcbiAgICBjb25zdCB7IHN1cHByZXNzRXJyb3JzIH0gPSBydW50aW1lSW5mby5zZWxlY3Rvck9wdGlvbnM7XHJcbiAgICBjb25zdCB7IGFyZ3VtZW50U2VsZWN0b3JGdW5jdGlvbnMgfSA9IHJ1bnRpbWVJbmZvO1xyXG5cclxuICAgIC8vIERldGVybWluZSBhcmd1bWVudHMgZnJvbSB0aGUgYXBwIHN0YXRlIHVzaW5nIHRoZSBzZWxlY3RvcnNcclxuICAgIHJlc3VsdHMucHVzaCguLi5hcmd1bWVudFNlbGVjdG9yRnVuY3Rpb25zLm1hcChhcmdGbiA9PiBhcmdGbihzdGF0ZSkpKTtcclxuXHJcbiAgICAvLyBpZiB0aGUgbGFtYmRhIHRyaWVzIHRvIGFjY2VzcyBhIHNvbWV0aGluZyBvbiB0aGVcclxuICAgIC8vIHN0YXRlIHRoYXQgZG9lc24ndCBleGlzdCwgaXQgd2lsbCB0aHJvdyBhIFR5cGVFcnJvci5cclxuICAgIC8vIHNpbmNlIHRoaXMgaXMgcXVpdGUgdXN1YWwgYmVoYXZpb3VyLCB3ZSBzaW1wbHkgcmV0dXJuIHVuZGVmaW5lZCBpZiBzby5cclxuICAgIHRyeSB7XHJcbiAgICAgIHJldHVybiBtZW1vaXplZEZuKC4uLnJlc3VsdHMpO1xyXG4gICAgfSBjYXRjaCAoZXgpIHtcclxuICAgICAgaWYgKGV4IGluc3RhbmNlb2YgVHlwZUVycm9yICYmIHN1cHByZXNzRXJyb3JzKSB7XHJcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgfVxyXG5cclxuICAgICAgdGhyb3cgZXg7XHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbiAgc2VsZWN0b3JNZXRhRGF0YS5zZWxlY3RGcm9tQXBwU3RhdGUgPSBzZWxlY3RGcm9tQXBwU3RhdGU7XHJcblxyXG4gIHJldHVybiBtZW1vaXplZEZuO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzZXR1cFNlbGVjdG9yTWV0YWRhdGE8VCBleHRlbmRzICguLi5hcmdzOiBhbnlbXSkgPT4gYW55PihcclxuICBtZW1vaXplZEZuOiBULFxyXG4gIG9yaWdpbmFsRm46IFQsXHJcbiAgY3JlYXRpb25NZXRhZGF0YTogQ3JlYXRpb25NZXRhZGF0YSB8IHVuZGVmaW5lZFxyXG4pIHtcclxuICBjb25zdCBzZWxlY3Rvck1ldGFEYXRhID0gZW5zdXJlU2VsZWN0b3JNZXRhZGF0YShtZW1vaXplZEZuKTtcclxuICBzZWxlY3Rvck1ldGFEYXRhLm9yaWdpbmFsRm4gPSBvcmlnaW5hbEZuO1xyXG4gIGxldCBnZXRFeHBsaWNpdFNlbGVjdG9yT3B0aW9ucyA9ICgpID0+ICh7fSk7XHJcbiAgaWYgKGNyZWF0aW9uTWV0YWRhdGEpIHtcclxuICAgIHNlbGVjdG9yTWV0YURhdGEuY29udGFpbmVyQ2xhc3MgPSBjcmVhdGlvbk1ldGFkYXRhLmNvbnRhaW5lckNsYXNzO1xyXG4gICAgc2VsZWN0b3JNZXRhRGF0YS5zZWxlY3Rvck5hbWUgPSBjcmVhdGlvbk1ldGFkYXRhLnNlbGVjdG9yTmFtZTtcclxuICAgIGdldEV4cGxpY2l0U2VsZWN0b3JPcHRpb25zID1cclxuICAgICAgY3JlYXRpb25NZXRhZGF0YS5nZXRTZWxlY3Rvck9wdGlvbnMgfHwgZ2V0RXhwbGljaXRTZWxlY3Rvck9wdGlvbnM7XHJcbiAgfVxyXG4gIGNvbnN0IHNlbGVjdG9yTWV0YURhdGFDbG9uZSA9IHsgLi4uc2VsZWN0b3JNZXRhRGF0YSB9O1xyXG4gIHNlbGVjdG9yTWV0YURhdGEuZ2V0U2VsZWN0b3JPcHRpb25zID0gKCkgPT5cclxuICAgIGdldEN1c3RvbVNlbGVjdG9yT3B0aW9ucyhzZWxlY3Rvck1ldGFEYXRhQ2xvbmUsIGdldEV4cGxpY2l0U2VsZWN0b3JPcHRpb25zKCkpO1xyXG4gIHJldHVybiBzZWxlY3Rvck1ldGFEYXRhO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRSdW50aW1lU2VsZWN0b3JJbmZvKFxyXG4gIHNlbGVjdG9yTWV0YURhdGE6IFNlbGVjdG9yTWV0YURhdGFNb2RlbCxcclxuICBzZWxlY3RvcnM6IGFueVtdIHwgdW5kZWZpbmVkID0gW11cclxuKTogUnVudGltZVNlbGVjdG9ySW5mbyB7XHJcbiAgY29uc3Qgc2VsZWN0b3JPcHRpb25zID0gc2VsZWN0b3JNZXRhRGF0YS5nZXRTZWxlY3Rvck9wdGlvbnMoKTtcclxuICBjb25zdCBzZWxlY3RvcnNUb0FwcGx5ID0gZ2V0U2VsZWN0b3JzVG9BcHBseShzZWxlY3Rvck1ldGFEYXRhLCBzZWxlY3RvcnMpO1xyXG4gIGNvbnN0IGFyZ3VtZW50U2VsZWN0b3JGdW5jdGlvbnMgPSBzZWxlY3RvcnNUb0FwcGx5Lm1hcChzZWxlY3RvciA9PiBnZXRTZWxlY3RvckZuKHNlbGVjdG9yKSk7XHJcbiAgcmV0dXJuIHtcclxuICAgIHNlbGVjdG9yT3B0aW9ucyxcclxuICAgIGFyZ3VtZW50U2VsZWN0b3JGdW5jdGlvbnNcclxuICB9O1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRDdXN0b21TZWxlY3Rvck9wdGlvbnMoXHJcbiAgc2VsZWN0b3JNZXRhRGF0YTogU2VsZWN0b3JNZXRhRGF0YU1vZGVsLFxyXG4gIGV4cGxpY2l0T3B0aW9uczogU2hhcmVkU2VsZWN0b3JPcHRpb25zXHJcbik6IFNoYXJlZFNlbGVjdG9yT3B0aW9ucyB7XHJcbiAgY29uc3Qgc2VsZWN0b3JPcHRpb25zOiBTaGFyZWRTZWxlY3Rvck9wdGlvbnMgPSB7XHJcbiAgICAuLi5nbG9iYWxTZWxlY3Rvck9wdGlvbnMuZ2V0KCksXHJcbiAgICAuLi4oc2VsZWN0b3JPcHRpb25zTWV0YUFjY2Vzc29yLmdldE9wdGlvbnMoc2VsZWN0b3JNZXRhRGF0YS5jb250YWluZXJDbGFzcykgfHwge30pLFxyXG4gICAgLi4uKHNlbGVjdG9yT3B0aW9uc01ldGFBY2Nlc3Nvci5nZXRPcHRpb25zKHNlbGVjdG9yTWV0YURhdGEub3JpZ2luYWxGbikgfHwge30pLFxyXG4gICAgLi4uKHNlbGVjdG9yTWV0YURhdGEuZ2V0U2VsZWN0b3JPcHRpb25zKCkgfHwge30pLFxyXG4gICAgLi4uZXhwbGljaXRPcHRpb25zXHJcbiAgfTtcclxuXHJcbiAgcmV0dXJuIHNlbGVjdG9yT3B0aW9ucztcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0U2VsZWN0b3JzVG9BcHBseShcclxuICBzZWxlY3Rvck1ldGFEYXRhOiBTZWxlY3Rvck1ldGFEYXRhTW9kZWwsXHJcbiAgc2VsZWN0b3JzOiBhbnlbXSB8IHVuZGVmaW5lZCA9IFtdXHJcbikge1xyXG4gIGNvbnN0IHNlbGVjdG9yc1RvQXBwbHkgPSBbXTtcclxuICBjb25zdCBjYW5JbmplY3RDb250YWluZXJTdGF0ZSA9XHJcbiAgICBzZWxlY3RvcnMubGVuZ3RoID09PSAwIHx8IHNlbGVjdG9yTWV0YURhdGEuZ2V0U2VsZWN0b3JPcHRpb25zKCkuaW5qZWN0Q29udGFpbmVyU3RhdGU7XHJcbiAgY29uc3QgY29udGFpbmVyQ2xhc3MgPSBzZWxlY3Rvck1ldGFEYXRhLmNvbnRhaW5lckNsYXNzO1xyXG4gIGlmIChjb250YWluZXJDbGFzcyAmJiBjYW5JbmplY3RDb250YWluZXJTdGF0ZSkge1xyXG4gICAgLy8gSWYgd2UgYXJlIG9uIGEgc3RhdGUgY2xhc3MsIGFkZCBpdCBhcyB0aGUgZmlyc3Qgc2VsZWN0b3IgcGFyYW1ldGVyXHJcbiAgICBjb25zdCBtZXRhZGF0YSA9IGdldFN0b3JlTWV0YWRhdGEoY29udGFpbmVyQ2xhc3MpO1xyXG4gICAgaWYgKG1ldGFkYXRhKSB7XHJcbiAgICAgIHNlbGVjdG9yc1RvQXBwbHkucHVzaChjb250YWluZXJDbGFzcyk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIGlmIChzZWxlY3RvcnMpIHtcclxuICAgIHNlbGVjdG9yc1RvQXBwbHkucHVzaCguLi5zZWxlY3RvcnMpO1xyXG4gIH1cclxuICByZXR1cm4gc2VsZWN0b3JzVG9BcHBseTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFRoaXMgZnVuY3Rpb24gZ2V0cyB0aGUgc2VsZWN0b3IgZnVuY3Rpb24gdG8gYmUgdXNlZCB0byBnZXQgdGhlIHNlbGVjdGVkIHNsaWNlIGZyb20gdGhlIGFwcCBzdGF0ZVxyXG4gKiBAaWdub3JlXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZ2V0U2VsZWN0b3JGbihzZWxlY3RvcjogYW55KTogU2VsZWN0RnJvbVN0YXRlIHtcclxuICBjb25zdCBtZXRhZGF0YSA9IGdldFNlbGVjdG9yTWV0YWRhdGEoc2VsZWN0b3IpIHx8IGdldFN0b3JlTWV0YWRhdGEoc2VsZWN0b3IpO1xyXG4gIHJldHVybiAobWV0YWRhdGEgJiYgbWV0YWRhdGEuc2VsZWN0RnJvbUFwcFN0YXRlKSB8fCBzZWxlY3RvcjtcclxufVxyXG4iXX0=